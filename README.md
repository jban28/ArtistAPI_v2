# ArtistAPI_v2
The original ArtistAPI was created using flask and deployed to AWS elastic beanstalk. This version 
is set up using AWS Lambda and AWS API Gateway due to the lower running costs of those services.

The current purpose of the ArtistAPI is to act as a backend for 
[mattpagett.co.uk](https://www.mattpagett.co.uk), though it has been designed to be extensible to
add in additional artists. The API allows the main website to retrive the data for images to be 
displayed, as well as providing authenticated endpoints for artists to update their images and add 
new images to their sites.

The front-end site for [mattpagett.co.uk](https://www.mattpagett.co.uk) is a VueJS SPA. When it is 
loaded it requests the data for all of Matt's images from the database and generates routes for each
based on the `url` attribute for each entry.

# Design

## Database
The database for this API is a mongoDB database hosted using mongoDB ATLAS. A connection to this 
mongo instance is established using a URI, which is stored in the repository secrets on GitHub.

Each artist is represented by their own table in the database. Each image entry in the database is 
stored in the following format:
```json
{
    "url": "/<series>/<image-name>", // url at which to display the image on the front end website
    "name": "Image name/title",
    "srcThumb": "<artist_name>/<series>/thumb/<id>.jpg",
    "srcFull": "<artist_name>/<series>/full/<id>.jpg",
    "caption": "Image caption text",
    "series": "<series_name>",
    "sequence": 1 // Defines the order in which to display the images on the front end site
},
```

## Image storage
The images for this API are stored in an AWS s3 bucket. Full size images are uploaded and a 
thumbnail size version is automatically generated by triggering a lambda function. The s3 bucket 
file structure pattern is `/artist/full/{id}.jpg` for full size images and `artist/thumb/{id}.jpg`
for thumbnails

## REST API (AWS API Gateway)
REST API created with two stages `live` and `dev`, which will point to correspondingly-named aliases
of the relevant lambda functions.

### Endpoints
|       Path       | HTTP Method | Description                                                            |            Headers            |                   URL Parameters                   |  Integration |
|:----------------:|:-----------:|------------------------------------------------------------------------|:-----------------------------:|:--------------------------------------------------:|:------------:|
|    `/image-data`   |     `GET`     | Retrieve image data for an artist, with options to sort by series      |                               | `artist={artist_identifier}, sort-by={none\|series}` | Lambda proxy |
|    `/image-data`   |     `POST`    | Upload data for a new image to database and return unique id for image |      `Authorization={JWT}`      |                                                    | Lambda proxy |
|    `/image-data`   |     `PUT`     | Batch update image data (mainly for reordering images)                 |      `Authorization={JWT}`      |                                                    | Lambda proxy |
| `/image-data/{id}` |     `PUT`     | Update data for a single image                                         |      `Authorization={JWT}`      |                                                    | Lambda proxy |
|    `/image/{id}`   |     `PUT`     | Upload new image to s3 bucket (called alongside POST /image-data)      |      `Authorization={JWT}`      |                                                    |   s3 bucket  |
|    `/image/{id}`   |    `DELETE`   | Delete image from s3 bucket and delete corresponding database entry   |      `Authorization={JWT}`      |                                                    | Lambda proxy |
|      `/login`      |     `POST`    | Login a user with username and password, return Json Web Token         | `Authorization={user:password}` |                                                    | Lambda proxy |

### Authorisation
Authenticated endpoints use a lambda function authoriser to validate the JWT generated by the 
login endpoint.

## Lambda Configuration
Each lambda function has a `live` and `dev` alias. `main` points to a specified version of the 
function, `dev` points to the `$latest` version. The code for each lambda function is published on 
each push to the corresponding git branch. Becasue of this set up, all commits to the `main` branch 
should be merged in from `dev`, as this ensures that `$latest` is in sync with the `dev` branch. 
If a change is merged to `main` from any other branch, or committed directly to `main`, then the 
`dev` alias will not be in sync with the `dev` branch, as the `$latest` version will be updated to 
the code on the `main` branch. Should this occur, it can be resolved by pushing a new commit on the 
`dev` branch, as this will then re-update the `$latest` version of the code to match `dev`.

### API endpoint integration functions
 - `image-data_GET`
 - `image-data_POST`
 - `image-data_PUT`
 - `image-data_id_PUT`
 - `image_id_DELETE`
 - `login_POST`

### Other functions
 - `authenticate` (API Gateway custom authorizer)
 - `cleanup` (Scheduled job to flag/remove any images not associated with a database entry)
 - `thumbnail` (triggered by s3 bucket upload - generate thumbnail image from full image)

### Layers
A single layer containing required packages is sufficient as all functions generally have 
similar requirements (see [requirements.txt](./requirements.txt))



# Testing
The tests folder contains a file called `test_interface.py`. This script runs unit tests 
for the code in the `src` folder. The test environment can be set by passing either
`LOCAL`, `DEV` or `LIVE` as the first command line argument to `test_interface.py`.
`LOCAL` runs tests using the local code, dev and live run tests through the corresponding 
API Gateway stages. Unit tests are run automatically on the local code and the development 
stage any time updated code is pushed to the remote `dev` branch using github actions.